{"version":3,"sources":["../../src/server/collect.js"],"names":["postcss","require","collect","html","css","animations","Set","other","root","critical","stylesheet","parse","htmlClassesRegExp","extractClassesFromHtml","isCritical","rule","selector","startsWith","Boolean","match","handleAtRule","addedToCritical","each","childRule","append","clone","name","remove","walkRules","parent","type","walkDecls","decl","add","value","split","walkAtRules","has","params","toString","htmlClasses","regex","exec","forEach","className","push","RegExp","join","module","exports"],"mappings":"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","sourcesContent":["/* @flow */\n\nconst postcss = require('postcss');\n\ntype CollectResult = {\n  critical: string,\n  other: string,\n};\n\nconst collect = (html: string, css: string): CollectResult => {\n  const animations = new Set();\n  const other = postcss.root();\n  const critical = postcss.root();\n  const stylesheet = postcss.parse(css);\n  const htmlClassesRegExp = extractClassesFromHtml(html);\n\n  const isCritical = rule => {\n    // Only check class names selectors\n    if (rule.selector.startsWith('.')) {\n      return Boolean(rule.selector.match(htmlClassesRegExp));\n    }\n\n    return true;\n  };\n\n  const handleAtRule = rule => {\n    let addedToCritical = false;\n\n    rule.each(childRule => {\n      if (isCritical(childRule)) {\n        critical.append(rule.clone());\n        addedToCritical = true;\n      }\n    });\n\n    if (rule.name === 'keyframes') {\n      return;\n    }\n\n    if (addedToCritical) {\n      rule.remove();\n    } else {\n      other.append(rule);\n    }\n  };\n\n  stylesheet.walkRules(rule => {\n    if (rule.parent.name === 'keyframes') {\n      return;\n    }\n\n    if (rule.parent.type === 'atrule') {\n      handleAtRule(rule.parent);\n      return;\n    }\n\n    if (isCritical(rule)) {\n      critical.append(rule);\n    } else {\n      other.append(rule);\n    }\n  });\n\n  critical.walkDecls(/animation/, decl => {\n    animations.add(decl.value.split(' ')[0]);\n  });\n\n  stylesheet.walkAtRules('keyframes', rule => {\n    if (animations.has(rule.params)) {\n      critical.append(rule);\n    }\n  });\n\n  return {\n    critical: critical.toString(),\n    other: other.toString(),\n  };\n};\n\nconst extractClassesFromHtml = (html: string): RegExp => {\n  const htmlClasses = [];\n  const regex = /\\s+class=\"([^\"]*)\"/gm;\n  let match = regex.exec(html);\n\n  while (match !== null) {\n    match[1].split(' ').forEach(className => htmlClasses.push(className));\n    match = regex.exec(html);\n  }\n\n  return new RegExp(htmlClasses.join('|'), 'gm');\n};\n\nmodule.exports = collect;\n"],"file":"collect.js"}